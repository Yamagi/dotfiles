# Global settings
# ---------------

# Allow passthrough of \ePtmux escape sequences to the
# underlying terminal. This was the default before tmux
# 3.3 and is used by several applications, vim with the
# terminus pluigin is a prominent example.
set -g allow-passthrough on

# Disallow renaming windows by sending escape sequences.
# But autorename them based upon the current process.
set -wg allow-rename off
set -wg automatic-rename on
set -wg automatic-rename-format "#{?pane_in_mode,[tmux],#{pane_current_command}}#{?pane_dead,[dead],}"

# Number windows starting from 1. While 0 is nicer from
# a computer since point of view the keyboard layout
# makes 1 a more natural choice.
set -sg base-index 1

# Somewhat faster escape sequences.
# (Since 3.1 the standard is 500 ms)
set -sg escape-time 250

# Report focus events to the cients when the
# pane changes or the terminal sends us one.
# Required for Vims autoread functionality,
set -g focus-events on

# Keep more line in the back buffer.
set -g history-limit 65536

# Monitor activity.
set -wg monitor-activity on
set -wg monitor-bell on
set -g visual-bell on

# Mouse mode.
set -g mouse on

# Renumber remaining sessions if one was closed.
set-hook -g session-created "run ~/.config/tmux/scripts/renumber-sessions.sh"
set-hook -g session-closed  "run ~/.config/tmux/scripts/renumber-sessions.sh"

# Renumber remaining windows if one was closed.
set -g renumber-windows on

# Environment variables transfered from the
# parrent environment at reattach.
set -g update-environment "SSH_AUTH_SOCK DISPLAY WAYLAND_DISPLAY XAUTHORITY"

# Aggressiv windows resizing.
set -wg aggressive-resize on
set -wg window-size latest

# ---------------------------------------------- #

# Terminal features
# -----------------

# Enable Truecolor support.
set -as terminal-features ",*:RGB"

# Enable colored undercurls. This is somewhat shaky,
# because not all common terminals support it and
# there's no reliable way to detect if the current
# terminal does. Since we don't use undercurls often
# it shouldn't be a big problem on xterm variants.
# Alacritty always supports them.
set -as terminal-features ",xterm-256color:usstyle"
set -as terminal-features ",alacritty:usstyle"

# Several older systems and FreeBSD general think
# that rxvt-unicode hasn't support for italics and
# map them to reverse video. Hack around that by
# forcing the correct escape sequences.
set -as terminal-overrides ",rxvt-unicode*:sitm=\e[3m,ritm=\e[23m"

# Enforce 256 color support.
set -sg default-terminal "tmux-256color"

# ---------------------------------------------- #

# Style
# -----

# Messages
set -g message-style 'fg=colour188,bg=colour233'
set -g message-command-style 'fg=colour188,bg=colour233'

# Panes
set -g pane-border-style 'fg=colour249,bg=colour233'
set -g pane-active-border-style 'fg=colour249,bg=colour233'

# Statusbar
set -g status-style 'fg=colour239,bg=colour249'

# Windows
set -wg window-style 'fg=colour188,bg=colour233'
set -wg window-status-activity-style 'fg=colour239,bold,bg=colour249'
set -wg window-status-bell-style 'fg=colour239,bold,bg=colour249'
set -wg window-status-current-style 'fg=colour188,bold,bg=colour24'

# ---------------------------------------------- #

# Statusbar
# ---------

set -g status-interval 1
set -g status-justify left
set -g status-left '#(/usr/bin/whoami)@#h | #S | '
set -g status-left-length 40
set -g status-right ' %a %d/%m/%y %H:%M:%S'
set -g status-right-length 25
set -wg window-status-current-format '#I:#W'
set -wg window-status-format '#I:#W'
set -wg window-status-separator ' | '

# ---------------------------------------------- #

# Bindings
# --------

# Prefixkey like in screen(1).
set -g prefix ^a

# vi Keybindings.
set -wg mode-keys vi
set -g status-keys vi

# Don't change the layout on space. I hit it too often by accident.
unbind-key Space

# Don't suspend the tmux client on Prefix<C-z>. Since I'm using tmux
# as kind of shell in my terminals this is more than annoying.
unbind-key C-z

# C-a a sends to nested tmux.
bind-key -N Prefix a send-prefix

# Quick window switch on Meta-1 to Meta-9.
bind-key -N "Switch to window 1" -n M-1 select-window -t :=1
bind-key -N "Switch to window 2" -n M-2 select-window -t :=2
bind-key -N "Switch to window 3" -n M-3 select-window -t :=3
bind-key -N "Switch to window 4" -n M-4 select-window -t :=4
bind-key -N "Switch to window 5" -n M-5 select-window -t :=5
bind-key -N "Switch to window 6" -n M-6 select-window -t :=6
bind-key -N "Switch to window 7" -n M-7 select-window -t :=7
bind-key -N "Switch to window 8" -n M-8 select-window -t :=8
bind-key -N "Switch to window 9" -n M-9 select-window -t :=9

# Nested mode on Meta-z. When in nested mode the status bar of the outer
# tmux is hidden and all keys are forwarded to the inner tmux. Only one
# level of nesting is supported. The idea was stolen from
# https://willhbr.net/2024/03/06/tmux-conf-with-commentary/
bind -N "Toggle nested mode" -n M-z {
	set status
	set key-table nested
	set prefix None
}
bind -N "Toggle nested mode" -T nested M-z {
	set status
	set key-table root
	set prefix C-a
}

# A scratch session in a popup window on M-s.
bind-key -N "Toggle scratch session popup" -n M-s display-popup -E \
		"~/.config/tmux/scripts/scratch-popup.sh"
bind-key -N "Toggle scratch session popup" -T popup M-s detach

# A popup menu with the most common operations on M-q. Rarely used,
# but sometimes rather helpful.
bind-key -N "Quick action chooser" -n M-q display-menu -x C -y C \
    "New Session"                        S "command-prompt -p \"New Session:\" \"new-session -A -s '%%'\"" \
    "Kill Session"                       x "kill-session" \
    "Kill Other Session(s)"              X "kill-session -a" \
    "" \
    "New Window"                         ‚êç "new-window" \
    "Kill Window"                        k "killw"  \
    "Choose Window"                      w "choose-window" \
    "Previous Window"                    ü°† "previous-window" \
    "Next Window"                        ü°¢ "next-window" \
    "Swap Window Right"                  ‚Üë "swap-window -t -1" \
    "Swap Window Left"                   ‚Üì "swap-window -t +1" \
    "Horizontal Split"                   v "split-window -h" \
    "Vertical Split"                     s "split-window -v"  \
    "" \
    "Layout Horizontal"                  h "select-layout even-horizontal"  \
    "Layout Vertical"                    k "select-layout even-horizontal"  \
    "" \
    "Swap Pane Up"                       < "swap-pane -U" \
    "Swap Pane Down"                     > "swap-pane -D" \
    "Break Pane"                         t "break-pane" \
    "Join Pane"                          j "choose-window 'join-pane -h -s \"%%\"'" \
    "#{?window_zoomed_flag,Unzoom,Zoom}" z "resize-pane -Z"

# ---------------------------------------------- #

# vim<->tmux-Navigator
# --------------------

# Requires https://github.com/christoomey/vim-tmux-navigator in vim.
# It must be configured to use the key sequences defined below.

is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind-key -N "Switch to left pane"  -n 'M-Left'  if-shell "$is_vim" \
		'send-keys M-h'  'select-pane -L'
bind-key -N "Switch to left pane"  -n 'M-h'     if-shell "$is_vim" \
		'send-keys M-h'  'select-pane -L'
bind-key -N "Switch to lower pane" -n 'M-Down'  if-shell "$is_vim" \
		'send-keys M-j'  'select-pane -D'
bind-key -N "Switch to lower pane" -n 'M-j'     if-shell "$is_vim" \
		'send-keys M-j'  'select-pane -D'
bind-key -N "Switch to upper pane" -n 'M-Up'    if-shell "$is_vim" \
		'send-keys M-k'  'select-pane -U'
bind-key -N "Switch to upper pane" -n 'M-k'     if-shell "$is_vim" \
		'send-keys M-k'  'select-pane -U'
bind-key -N "Switch to right pane" -n 'M-Right' if-shell "$is_vim" \
		'send-keys M-l'  'select-pane -R'
bind-key -N "Switch to right pane" -n 'M-l'     if-shell "$is_vim" \
		'send-keys M-l'  'select-pane -R'

bind-key -N "Switch to left pane"  -T nested 'M-Left'  'send-keys M-h'
bind-key -N "Switch to left pane"  -T nested 'M-h'     'send-keys M-h'
bind-key -N "Switch to lower pane" -T nested 'M-Down'  'send-keys M-j'
bind-key -N "Switch to lower pane" -T nested 'M-j'     'send-keys M-j'
bind-key -N "Switch to upper pane" -T nested 'M-Up'    'send-keys M-k'
bind-key -N "Switch to upper pane" -T nested 'M-k'     'send-keys M-k'
bind-key -N "Switch to right pane" -T nested 'M-Right' 'send-keys M-l'
bind-key -N "Switch to right pane" -T nested 'M-l'     'send-keys M-l'

bind-key -N "Switch to left pane"  -T copy-mode-vi 'M-Left'  select-pane -L
bind-key -N "Switch to left pane"  -T copy-mode-vi 'M-h'     select-pane -L
bind-key -N "Switch to lower pane" -T copy-mode-vi 'M-Down'  select-pane -D
bind-key -N "Switch to lower pane" -T copy-mode-vi 'M-j'     select-pane -D
bind-key -N "Switch to upper pane" -T copy-mode-vi 'M-Up'    select-pane -U
bind-key -N "Switch to upper pane" -T copy-mode-vi 'M-k'     select-pane -U
bind-key -N "Switch to right pane" -T copy-mode-vi 'M-Right' select-pane -R
bind-key -N "Switch to right pane" -T copy-mode-vi 'M-l'     select-pane -R
